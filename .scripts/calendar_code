#!/bin/zsh
autoload +X _complete
autoload -U compinit && compinit
source /usr/bin/aws_zsh_completer.sh
functions[_original_complete]=$functions[_complete]
_complete () {
  unset 'compstate[vared]'
  _original_complete "$@"
}
trap ctrl_c INT
function ctrl_c() {
        echo "Please type 'q' or 'Q' to quit"
}
re='^[0-9]+$'
FILTER=""
long_comparator=14
LINELIMIT="limit: $long_comparator"
DETAIL="list"
LONGLIMIT=1000
FOCUS=""
i3-msg title_format "Calendar"
DUE=""
HELP=0
SHOW_CALENDAR=true
while true; do
        clear
        unbuffer task $FOCUS $DETAIL $FILTER $DUE $LINELIMIT | head -n $LONGLIMIT
        if [ "$SHOW_CALENDAR" = true ]; then
                task calendar
        else
                echo " "
        fi
        if [ $HELP -eq 1 ]; then
                echo "project:\ndue:\nlimit:\nfocus:\ndetail:\nnew_limit:"
                HELP=0
        fi
        COMMAND=''
        vared COMMAND
        if [[ $COMMAND = "q" ]] || [[ $COMMAND = "Q" ]]
                then break
            else
                if [[ $COMMAND == "project:"* ]] then
                        if [[ $COMMAND == *"all"* ]] then
                                FILTER=""
                        else
                                FILTER=$COMMAND
                        fi
                elif [[ $COMMAND == "help"* ]] then
                        HELP=1
                elif [[ $COMMAND == "due:"* ]] then
                        if [[ $COMMAND == *"all"* ]] then
                                DUE=""
                        else
                                DUE=$COMMAND
                        fi
                elif [[ $COMMAND == "limit:"* ]] then
                        CURRENTLIMIT=${COMMAND//limit:/}
                        if [[ $CURRENTLIMIT =~ $re ]] ; then
                                LINELIMIT=$COMMAND
                        fi
                        if [[ $CURRENTLIMIT == *"all"* ]] then
                                LINELIMIT=$COMMAND
                                LONGLIMIT=1000
                        elif [[ $CURRENTLIMIT == *"fit"* ]] then
                                LINELIMIT="limit: $long_comparator"
                                LONGLIMIT=19
                        else
                                if [ "$CURRENTLIMIT" -le "$long_comparator" ]
                                then
                                        LONGLIMIT=18
                                else
                                        LONGLIMIT=1000
                                fi
                        fi
                elif [[ $COMMAND == "focus:"* ]] then
                        if [[ $COMMAND == *"all"* ]] then
                                FOCUS=""
                        else
                                FOCUS=${COMMAND//focus:/}
                        fi
                elif [[ $COMMAND == "new_limit:"* ]] then
                        long_comparator=${COMMAND//new_limit:/}
                        LINELIMIT="limit: $long_comparator"
                elif [[ $COMMAND == "detail:"* ]] then
                        if [[ $COMMAND == *"long"* ]] then
                                DETAIL="long"
                                if [ "$LIMIT" -le "$long_comparator" ]
                                then
                                        LONGLIMIT="$(($long_comparator+3))"
                                else
                                        LONGLIMIT=1000
                                fi
                        else
                                DETAIL="list"
                                LONGLIMIT=1000
                        fi
                elif [[ $COMMAND == "calendar:"* ]] then
                        CALENDAR_STATE=${COMMAND//calendar:/}
                        if [[ $CALENDAR_STATE == *"off"* ]] then
                                SHOW_CALENDAR=false
                        elif [[ $CALENDAR_STATE == *"on"* ]] then
                                SHOW_CALENDAR=true
                        fi
                else
                       eval $COMMAND
                fi
        fi
done
